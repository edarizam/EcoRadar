<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Energ칠tico</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* 游늷 Ajuste de la tabla para ser m치s responsiva */
      .table-container {
        max-height: 430px;
        overflow-y: auto;
      }

      /* 游늷 Permitir que el gr치fico se ajuste al contenedor */
      .chart-wrapper {
        position: relative;
        width: 100%;
        height: auto;
        min-height: 300px; /* 游늷 Garantiza un tama침o m칤nimo */
      }

      /* 游늷 Mejor ajuste en pantallas peque침as */
      @media (max-width: 768px) {
        .table-container {
          max-height: 300px;
        }
      }
    </style>
    <style>
      :root {
        --primary-color: #315c2b;
        --dark-hover: #284822;
        --dark-active: #1f3a1b;
        --navbar-bg: #181f1c;
        --navbar-hover: #9ea93f;
      }

      .btn-bd-primary,
      .btn-primary {
        --bs-btn-font-weight: 600;
        --bs-btn-color: #fff;
        --bs-btn-bg: var(--primary-color);
        --bs-btn-border-color: var(--primary-color);
        --bs-btn-hover-bg: var(--dark-hover);
        --bs-btn-hover-border-color: var(--dark-hover);
        --bs-btn-focus-shadow-rgb: 49, 92, 43;
        --bs-btn-active-bg: var(--dark-active);
        --bs-btn-active-border-color: var(--dark-active);
      }

      .btn-outline-primary {
        color: var(--primary-color) !important;
        border-color: var(--primary-color) !important;
      }
      .btn-outline-primary:hover {
        background-color: var(--primary-color) !important;
        color: white !important;
      }

      .navbar-custom {
        background-color: var(--navbar-bg) !important;
      }
      .navbar-custom .nav-link {
        color: white !important;
      }
      .navbar-custom .nav-link:hover {
        color: var(--navbar-hover) !important;
      }
    </style>
  </head>
  <body>
    <header data-bs-theme="dark">
      <nav class="navbar navbar-expand-md navbar-custom fixed-top">
        <div class="container-fluid">
          <a href="/">
            <img
              src="/img/Ecoradarlogo.png"
              alt="Logo"
              style="width: 80px; height: 80px; padding: 0; margin: 0"
            />
          </a>
          <button
            class="navbar-toggler"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#navbarCollapse"
            aria-controls="navbarCollapse"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  th:href="@{/informacion}"
                  >Informaci칩n</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  th:href="@{/rankings}"
                  >Rankings</a
                >
              </li>
              <li class="nav-item">
                <a
                  class="nav-link active"
                  aria-current="page"
                  th:href="@{/formularioinfo}"
                  >Comparaci칩n</a
                >
              </li>
              <li class="nav-item">
                <a class="nav-link active" th:href="@{/contacto}">Con칩cenos</a>
              </li>
            </ul>
          </div>
          <div class="col-md-3 text-end">
            <button type="button" class="btn btn-outline-primary me-2">
              Login
            </button>
            <button type="button" class="btn btn-primary">Sign-up</button>
          </div>
        </div>
      </nav>
    </header>
  </body>
  <body style="padding-top: 70px">
    <div class="container mt-4">
      <h1 class="text-center">RANKINGS</h1>
      <p class="text-center text-muted">
        En esta p치gina puedes explorar el ranking de diferentes tipos de
        energ칤as:
        <strong>E칩lica, Hidr치ulica, Solar y Biomasa</strong>. Podr치s elegir si
        quieres ver el <strong>consumo</strong> o la
        <strong>producci칩n</strong> seg칰n el tipo de energ칤a en un a침o
        espec칤fico y ordenar la lista pa칤ses de <strong>mayor a menor</strong> o
        viceversa. Para visualizar los datos, llena los campos y presiona
        <strong>Enter</strong>. En el gr치fico de torta podr치s ver el
        <strong>top 10 de pa칤ses</strong> seg칰n la informaci칩n seleccionada y en
        la tabla podr치s ver la lista completa.
      </p>
      <!-- Gr치ficos y tablas energias -->
      <main>
        <div class="container mt-4">
          <div class="row" id="energias-container"></div>
        </div>

        <script>
          document.addEventListener("DOMContentLoaded", function () {
            const energias = ["E칩lica", "Hidr치ulica", "Solar", "Biomasa"];
            const container = document.getElementById("energias-container");
            const defaultTitlesEnergyTypes = {
              Hiadr치ulica: "hydro",
              Solar: "solar",
              E칩lica: "wind",
              Biomasa: "bio",
            };
            const energyMapping = {
              Hiadr치ulica: "hydroData",
              Solar: "solarData",
              E칩lica: "windData",
              Biomasa: "bioData",
            };
            const traductor = {
              consumption: "consumo",
              production: "producci칩n",
            };
            energias.forEach((energia) => {
              container.innerHTML += `
          <div class="container">
              <div class="row justify-content-center text-center mb-3">
                  <div class="col-md-12 bg-light py-2 rounded">
                      <h3 class="mb-0">${energia}</h3>
                  </div>
                  <div class="col-md-10 d-flex justify-content-center flex-wrap gap-2">
                      <select class="form-select form-select-sm tipoEnergia" id= "energy-type" data-energia="${energia}" style="max-width: 200px;">
                          <option selected disabled>Seleccione el indicador energ칠tico</option>
                          <option value="consumption">Consumo</option>
                          <option value="production">Producci칩n</option>
                      </select>
                      <select class="form-control form-control-sm anioEnergia" id= "energy-year" data-energia="${energia}" style="max-width: 120px;">
                          <option value="" disabled selected>A침o</option>
                      </select>
                      <div class="dropdown">
                          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">Ordenar</button>
                          <ul class="dropdown-menu">
                              <li><button class="dropdown-item ordenar" data-energia="${energia}" data-orden="desc">Mayor a menor</button></li>
                              <li><button class="dropdown-item ordenar" data-energia="${energia}" data-orden="asc">Menor a mayor</button></li>
                          </ul>
                      </div>
                  </div>
              </div>

              <div class="row justify-content-center align-items-center position-relative">
                  <div class="col-md-5 mx-2">
                      <div class="text-center">
                          <h5 class="chart-title my-3" id="chartTitle-${energia}" style="display: none;"></h5>
                      </div>
                      <div class="chart-wrapper position-relative d-flex align-items-center justify-content-center" style="min-height: 300px;">
                          <canvas id="chart${energia}" class="chart-placeholder"></canvas>
                      </div>
                  </div>

                  <div class="col-md-5 mx-2">
                      <div class="text-center">
                          <h5 class="table-title my-3" id="tableTitle-${energia}" style="display: none;"></h5>
                      </div>
                      <div class="table-responsive table-container">
                          <table class="table table-striped table-hover table-bordered text-center align-middle" id="energyTable-${energia}" style="display: none;">
                              <thead class="table-dark">
                                  <tr>
                                      <th>ID</th>
                                      <th>PA칈S</th>
                                      <th id="columna-${energia}">VALOR</th>
                                  </tr>
                              </thead>
                              <tbody></tbody>
                          </table>
                      </div>
                  </div>

                  <!-- Mensaje Placeholder Centrado -->
                  <div class="placeholder-message position-absolute text-center" id="placeholder-${energia}" style="color: #b0b0b0;">
                      <p class="fs-4">Por favor, llena los datos para visualizar el gr치fico y la tabla.</p>
                      <p class="fs-1">游댌</p>
                  </div>
              </div>
          </div>
                      `;
            });

            let charts = {};
            const selecttype = document.getElementById("energy-type");
            const selectyear = document.getElementById("energy-year");
            selectyear.disabled = true;

            selecttype.addEventListener("change", async function () {
              const energytype = selecttype.value;
              const years =
                (await getData(`http://localhost:8080/${energytype}/year`)) ||
                [];
              years.forEach((year) => {
                let option = document.createElement("option");
                option.value = year;
                option.textContent = year;
                selectyear.appendChild(option);
              });
              selectyear.disabled = false;
            });

            document.querySelectorAll(".ordenar").forEach((button) => {
              button.addEventListener("click", function () {
                actualizarDatos(this.dataset.energia, this.dataset.orden);
              });
            });

            async function getData(url) {
              try {
                const response = await fetch(url, {
                  method: "GET",
                  headers: { "Content-Type": "application/json" },
                });
                if (!response.ok)
                  throw new Error(`HTTP error! Status: ${response.status}`);
                return await response.json();
              } catch (error) {
                console.error("Error al obtener los datos:", error);
                return null;
              }
            }

            async function obtenerDatos(energia, tipo, anio, orden) {
              const url = `http://localhost:8080/${tipo}/${defaultTitlesEnergyTypes[energia]}/ranking/${anio}`;
              return await getData(url);
            }

            async function actualizarDatos(energia, orden = "desc") {
              const tipo = selecttype.value;
              const anio = selectyear.value;
              if (!tipo || !anio) return;

              const data = await obtenerDatos(energia, tipo, anio, orden);
              console.log(data);
              const energyKey = energyMapping[energia];
              actualizarGrafico(energia, data, energyKey);
              actualizarTabla(energia, data, energyKey);
              actualizarTitulos(energia, traductor[tipo], anio, orden);
              manejarPlaceholder(energia, true);
            }

            function actualizarGrafico(energia, data, tipo) {
              const ctx = document
                .getElementById(`chart${energia}`)
                .getContext("2d");
              if (!ctx) return;

              const labels = data.map((d) => d.location);
              const valores = data.map((d) => d[tipo]);

              if (charts[energia]) {
                charts[energia].destroy();
              }

              charts[energia] = new Chart(ctx, {
                type: "doughnut",
                data: {
                  labels: labels,
                  datasets: [
                    {
                      label: tipo.charAt(0).toUpperCase() + tipo.slice(1),
                      data: valores,
                    },
                  ],
                },
              });
            }

            function actualizarTabla(energia, data, tipo) {
              const table = document.getElementById(`energyTable-${energia}`);
              const tbody = table.querySelector("tbody");

              if (!tbody) return;

              if (data.length === 0) {
                table.style.display = "none";
                return;
              }

              tbody.innerHTML = data
                .map(
                  (d, index) => `
                      <tr>
                          <td>${index + 1}</td>
                          <td>${d.location}</td>
                          <td>${d[tipo].toFixed(2)}</td>
                      </tr>
                      `
                )
                .join("");

              table.style.display = "table";

              document.getElementById(`columna-${energia}`).textContent =
                traductor[selecttype.value][0].toUpperCase() +
                traductor[selecttype.value].substring(1);
            }

            function actualizarTitulos(energia, tipo, anio, orden) {
              const chartTitle = document.getElementById(
                `chartTitle-${energia}`
              );
              const tableTitle = document.getElementById(
                `tableTitle-${energia}`
              );

              chartTitle.innerText = `Top 10 pa칤ses con mayor ${tipo} de energ칤a ${energia} en ${anio}`;
              chartTitle.style.display = "block";

              tableTitle.innerText = `Lista completa de pa칤ses con mayor ${tipo} de energ칤a ${energia} en ${anio}`;
              tableTitle.style.display = "block";
            }

            function manejarPlaceholder(energia, mostrar) {
              const placeholder = document.getElementById(
                `placeholder-${energia}`
              );
              placeholder.style.display = mostrar ? "none" : "block";
            }

            selectyear.addEventListener("change", function () {
              actualizarDatos(selecttype.dataset.energia);
            });
          });
        </script>
      </main>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    </div>
    <footer class="bg-dark text-white text-center py-3">
      <p>
        &copy; 2025 EcoRadar &middot; <a href="#">Privacy</a> &middot;
        <a href="#">Terms</a> &middot; <a href="#">Contacto</a>
      </p>
    </footer>
  </body>
</html>
